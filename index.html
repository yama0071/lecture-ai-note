<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¬›ç¾©éŸ³å£°ãƒãƒ¼ãƒˆAI (Gemini 3ç‰ˆ)</title>
    <style>
        :root { --primary-color: #2F9444; --bg-color: #F3F4F6; --card-bg: #FFFFFF; --text-main: #1F2937; --border-color: #E5E7EB; }
        body { font-family: sans-serif; background-color: var(--bg-color); color: var(--text-main); padding: 20px; line-height: 1.6; }
        .container { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--primary-color); font-size: 1.5rem; }
        input, button { width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 1rem; }
        button { background: var(--primary-color); color: white; font-weight: bold; cursor: pointer; border: none; margin-top: 15px; }
        button:disabled { background: #9CA3AF; }
        .result-content { background: #F9FAFB; border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; white-space: pre-wrap; margin-top: 10px; min-height: 100px; }
        .loading { display: none; text-align: center; margin: 20px 0; }
        .spinner { width: 30px; height: 30px; border: 4px solid #ddd; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ™ï¸ è¬›ç¾©éŸ³å£°ãƒãƒ¼ãƒˆAI</h1>
        
        <div class="card">
            <label>Gemini API Key</label>
            <input type="password" id="api-key" placeholder="AIza...">
            <button onclick="saveKey()">ã‚­ãƒ¼ã‚’ä¿å­˜</button>
        </div>

        <div class="card">
            <label>è¬›ç¾©å</label>
            <input type="text" id="lecture-name" placeholder="ä¾‹: çµŒæ¸ˆå­¦ç¬¬1å›">
            <label>éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ« (30ç§’ã€œ1åˆ†æ¨å¥¨)</label>
            <input type="file" id="audio-file" accept="audio/*">
            <button id="analyze-btn" onclick="startAnalysis()">è§£æã‚¹ã‚¿ãƒ¼ãƒˆ â–¶</button>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>GeminiãŒéŸ³å£°ã‚’è§£æä¸­...</p>
        </div>

        <div class="card" id="result-area" style="display:none;">
            <h3>AIè¦ç´„ã¨è¦ç‚¹</h3>
            <div id="summary-3lines" class="result-content" style="background: #eefdf0; border-color: #2F9444;"></div>
            
            <h3>æ–‡å­—èµ·ã“ã—å…¨æ–‡</h3>
            <div id="transcript-text" class="result-content"></div>
            
            <button onclick="copyText()">ã™ã¹ã¦ã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
    </div>

    <script>
        const GEMINI_MODEL = "gemini-3-flash-preview"; 

        window.onload = () => {
            document.getElementById('api-key').value = localStorage.getItem('gemini_api_key') || '';
        };

        function saveKey() {
            const key = document.getElementById('api-key').value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                alert('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            }
        }

        async function startAnalysis() {
            const key = localStorage.getItem('gemini_api_key');
            const file = document.getElementById('audio-file').files[0];
            const lectureName = document.getElementById('lecture-name').value || "è¬›ç¾©";

            if (!key || !file) return alert('ã‚­ãƒ¼ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„');

            const btn = document.getElementById('analyze-btn');
            const loading = document.getElementById('loading');
            const resultArea = document.getElementById('result-area');
            
            btn.disabled = true;
            loading.style.display = 'block';
            resultArea.style.display = 'none';

            try {
                const base64Data = await fileToBase64(file);
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${key}`;

                // 1. æ–‡å­—èµ·ã“ã—ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { inline_data: { mime_type: file.type, data: base64Data } },
                                { text: "ã“ã®éŸ³å£°ã‚’æ–‡å­—èµ·ã“ã—ã—ã¦ãã ã•ã„ã€‚ã‚‚ã—å†…å®¹ãŒãªã„å ´åˆã¯ã€å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“ã€ã¨å›ç­”ã—ã¦ãã ã•ã„ã€‚" }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || 'é€šä¿¡ã‚¨ãƒ©ãƒ¼');
                const transcript = data.candidates[0].content.parts[0].text;
                document.getElementById('transcript-text').innerText = transcript;

                // 2. è¦ç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const summaryPrompt = `${lectureName}ã®è¬›ç¾©éŒ²ã§ã™ã€‚3è¡Œã§è¦ç´„ã—ã€ãã®å¾Œã«è¦ç‚¹ã‚’3ã¤ã®ç®‡æ¡æ›¸ãã§ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚\n\n${transcript}`;
                const sResponse = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: summaryPrompt }] }] })
                });
                const sData = await sResponse.json();
                const summaryText = sData.candidates[0].content.parts[0].text;

                document.getElementById('summary-3lines').innerText = summaryText;
                resultArea.style.display = 'block';

            } catch (err) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + err.message);
            } finally {
                btn.disabled = false;
                loading.style.display = 'none';
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function copyText() {
            const transcript = document.getElementById('transcript-text').innerText;
            const summary = document.getElementById('summary-3lines').innerText;
            navigator.clipboard.writeText(`ã€è¦ç´„ãƒ»è¦ç‚¹ã€‘\n${summary}\n\nã€å…¨æ–‡ã€‘\n${transcript}`);
            alert('ã™ã¹ã¦ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        }
    </script>
</body>
</html>